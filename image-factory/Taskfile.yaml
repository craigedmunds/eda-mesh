version: '3'

tasks:
  test:integration:
    desc: Run Kargo integration test for Image Factory
    dir: .
    cmds:
      - npm install
      - npm run test:kargo
    
  test:unit:
    desc: Run unit tests for Image Factory
    dir: .
    cmds:
      - python -m pytest test_integration.py -v
      
  test:all:
    desc: Run all tests (unit + integration)
    deps:
      - test:unit
      - test:integration
      
  cdk8s:synth:
    desc: Synthesize CDK8s manifests
    dir: cdk8s
    cmds:
      - uv run cdk8s synth
      
  cdk8s:deploy:
    desc: Deploy CDK8s manifests to cluster
    dir: cdk8s
    deps:
      - cdk8s:synth
    cmds:
      - kubectl apply -f dist/image-factory.k8s.yaml
      
  tool:run:
    desc: Run the image factory analysis tool
    dir: app
    cmds:
      - uv run python app.py --image-factory-dir ../

  tool:run:uv:
    desc: Run analysis tool for UV image (local testing)
    dir: app
    cmds:
      - uv run python app.py 
        --image uv 
        --tag "local-test" 
        --digest "sha256:local-test" 
        --dockerfile "apps/uv/Dockerfile" 
        --source-repo "craigedmunds/argocd-eda" 
        --source-provider "github" 
        --git-repo "https://github.com/craigedmunds/argocd-eda.git" 
        --git-branch "main" 
        --image-factory-dir ../

  tool:run:backstage:
    desc: Run analysis tool for Backstage image (local testing)
    dir: app
    cmds:
      - uv run python app.py 
        --image backstage 
        --tag "local-test" 
        --digest "sha256:local-test" 
        --dockerfile "backstage/app/packages/backend/Dockerfile" 
        --source-repo "craigedmunds/argocd-eda" 
        --source-provider "github" 
        --git-repo "https://github.com/craigedmunds/argocd-eda.git" 
        --git-branch "main" 
        --image-factory-dir ../

  # Diagnostic and Status Tasks
  status:
    desc: Show comprehensive status of Image Factory components
    cmds:
      - echo "=== Image Factory Status Overview ==="
      - echo ""
      - echo "üìã Kargo Project Status:"
      - kubectl get project image-factory-kargo -n image-factory-kargo -o wide || echo "‚ùå Project not found"
      - echo ""
      - echo "üè≠ Warehouses Status:"
      - kubectl get warehouses -n image-factory-kargo -o wide || echo "‚ùå No warehouses found"
      - echo ""
      - echo "üé≠ Stages Status:"
      - kubectl get stages -n image-factory-kargo -o wide || echo "‚ùå No stages found"
      - echo ""
      - echo "üì¶ Freight Status:"
      - kubectl get freight -n image-factory-kargo -o wide || echo "‚ùå No freight found"
      - echo ""
      - echo "üöÄ Promotions Status (last 10):"
      - kubectl get promotions -n image-factory-kargo --sort-by=.metadata.creationTimestamp -o wide | tail -11 || echo "‚ùå No promotions found"
      - echo ""
      - echo "üî¨ AnalysisRuns Status:"
      - kubectl get analysisruns -n image-factory-kargo -o wide || echo "‚ùå No analysis runs found"
      - echo ""
      - echo "‚öôÔ∏è Jobs Status:"
      - kubectl get jobs -n image-factory-kargo -o wide || echo "‚ùå No jobs found"
      - echo ""
      - echo "üê≥ Pods Status:"
      - kubectl get pods -n image-factory-kargo -o wide || echo "‚ùå No pods found"

  logs:
    desc: Show logs from all running Image Factory components
    cmds:
      - echo "=== Image Factory Logs ==="
      - echo ""
      - echo "üìã Recent Events:"
      - kubectl get events -n image-factory-kargo --sort-by='.lastTimestamp' | tail -20 || echo "‚ùå No events found"
      - echo ""
      - echo "‚öôÔ∏è Job Logs (if any running):"
      - kubectl get jobs -n image-factory-kargo -o name | xargs -I {} kubectl logs -n image-factory-kargo {} --tail=50 || echo "‚ùå No jobs found"
      - echo ""
      - echo "ÔøΩ Pod Ltogs (if any running):"
      - kubectl get pods -n image-factory-kargo --field-selector=status.phase=Running -o name | xargs -I {} kubectl logs -n image-factory-kargo {} --tail=50 || echo "‚ùå No running pods found"

  logs:analysis:
    desc: Show logs from the most recent AnalysisRun
    cmds:
      - echo "=== Most Recent AnalysisRun Logs ==="
      - kubectl get analysisruns -n image-factory-kargo --sort-by=.metadata.creationTimestamp -o name | tail -1 | xargs -I {} kubectl describe -n image-factory-kargo {} || echo "‚ùå No AnalysisRuns found"

  logs:promotion:
    desc: Show logs from the most recent promotion
    cmds:
      - echo "=== Most Recent Promotion Logs ==="
      - kubectl get promotions -n image-factory-kargo --sort-by=.metadata.creationTimestamp -o name | tail -1 | xargs -I {} kubectl describe -n image-factory-kargo {} || echo "‚ùå No promotions found"

  debug:stage:
    desc: Debug a specific stage
    cmds:
      - echo "=== Stage Debug ==="
      - echo ""
      - echo "üìã Stage Configuration:"
      - kubectl get stage {{.STAGE | default "analyze-dockerfile-uv"}} -n image-factory-kargo -o yaml || echo "‚ùå Stage not found"
      - echo ""
      - echo "ÔøΩ Recenot Promotions for this Stage:"
      - kubectl get promotions -n image-factory-kargo --sort-by=.metadata.creationTimestamp | grep {{.STAGE | default "analyze-dockerfile-uv"}} | tail -5 || echo "‚ùå No promotions found"
      - echo ""
      - echo "üî¨ Recent AnalysisRuns for this Stage:"
      - kubectl get analysisruns -n image-factory-kargo --sort-by=.metadata.creationTimestamp | grep {{.STAGE | default "analyze-dockerfile-uv"}} | tail -5 || echo "‚ùå No analysis runs found"

  debug:secrets:
    desc: Debug secret configuration and availability
    cmds:
      - echo "=== Secrets Debug ==="
      - echo ""
      - echo "üîê Available Secrets:"
      - kubectl get secrets -n image-factory-kargo || echo "‚ùå No secrets found"
      - echo ""
      - echo "üîç ServiceAccount Configuration:"
      - kubectl get serviceaccount image-factory -n image-factory-kargo -o yaml || echo "‚ùå ServiceAccount not found"

  clean:failed:
    desc: Clean up failed jobs and pods
    cmds:
      - echo "=== Cleaning Failed Resources ==="
      - echo ""
      - echo "üßπ Deleting failed jobs:"
      - kubectl delete jobs -n image-factory-kargo --field-selector status.successful=0 || echo "‚ùå No failed jobs to delete"
      - echo ""
      - echo "üßπ Deleting failed pods:"
      - kubectl delete pods -n image-factory-kargo --field-selector status.phase=Failed || echo "‚ùå No failed pods to delete"

  watch:
    desc: Watch Image Factory resources in real-time
    cmds:
      - echo "=== Watching Image Factory Resources ==="
      - echo "Press Ctrl+C to stop watching"
      - kubectl get promotions,analysisruns,jobs,pods -n image-factory-kargo -w