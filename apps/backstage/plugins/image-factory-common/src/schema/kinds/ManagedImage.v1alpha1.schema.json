{
  "$schema": "http://json-schema.org/draft-07/schema",
  "$id": "ManagedImageV1alpha1",
  "description": "A ManagedImage represents a container image that is built and maintained by the organization",
  "examples": [
    {
      "apiVersion": "image-factory.io/v1alpha1",
      "kind": "ManagedImage",
      "metadata": {
        "name": "backstage",
        "title": "Backstage",
        "description": "Backstage developer portal backend",
        "annotations": {
          "image-factory.io/registry": "ghcr.io",
          "image-factory.io/repository": "craigedmunds/backstage",
          "image-factory.io/digest": "sha256:abc123",
          "image-factory.io/last-built": "2024-12-09T10:00:00Z",
          "image-factory.io/rebuild-status": "up-to-date"
        }
      },
      "spec": {
        "type": "managed-image",
        "lifecycle": "production",
        "owner": "platform-team",
        "system": "image-factory",
        "source": {
          "provider": "github",
          "repo": "craigedmunds/argocd-eda",
          "branch": "main",
          "dockerfile": "apps/backstage/packages/backend/Dockerfile",
          "workflow": "backstage.yml"
        },
        "rebuildPolicy": {
          "delay": "7d",
          "autoRebuild": true
        },
        "dependsOn": [
          {
            "resource": "node-22-bookworm-slim",
            "type": "base-image"
          }
        ]
      }
    }
  ],
  "allOf": [
    {
      "$ref": "Entity"
    },
    {
      "type": "object",
      "required": ["spec"],
      "properties": {
        "apiVersion": {
          "enum": ["image-factory.io/v1alpha1"]
        },
        "kind": {
          "enum": ["ManagedImage"]
        },
        "spec": {
          "type": "object",
          "required": ["type", "lifecycle", "owner", "source", "rebuildPolicy"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["managed-image"],
              "description": "The type of the image entity"
            },
            "lifecycle": {
              "type": "string",
              "description": "The lifecycle state of the image",
              "examples": ["experimental", "production", "deprecated"],
              "minLength": 1
            },
            "owner": {
              "type": "string",
              "description": "An entity reference to the owner of the image",
              "examples": ["platform-team", "user:john.johnson"],
              "minLength": 1
            },
            "system": {
              "type": "string",
              "description": "An entity reference to the system that the image belongs to",
              "minLength": 1
            },
            "source": {
              "type": "object",
              "required": ["provider", "repo", "branch", "dockerfile", "workflow"],
              "properties": {
                "provider": {
                  "type": "string",
                  "enum": ["github", "gitlab"],
                  "description": "The source code provider"
                },
                "repo": {
                  "type": "string",
                  "description": "The repository containing the Dockerfile",
                  "minLength": 1
                },
                "branch": {
                  "type": "string",
                  "description": "The branch to build from",
                  "minLength": 1
                },
                "dockerfile": {
                  "type": "string",
                  "description": "Path to the Dockerfile in the repository",
                  "minLength": 1
                },
                "workflow": {
                  "type": "string",
                  "description": "The workflow file name for building the image",
                  "minLength": 1
                }
              }
            },
            "rebuildPolicy": {
              "type": "object",
              "required": ["delay", "autoRebuild"],
              "properties": {
                "delay": {
                  "type": "string",
                  "description": "Delay period after base image updates before triggering rebuild",
                  "pattern": "^\\d+[dhm]$",
                  "examples": ["7d", "24h", "30m"]
                },
                "autoRebuild": {
                  "type": "boolean",
                  "description": "Whether to automatically trigger rebuilds"
                }
              }
            },
            "dependsOn": {
              "type": "array",
              "description": "Base images that this managed image depends on",
              "items": {
                "type": "object",
                "required": ["resource", "type"],
                "properties": {
                  "resource": {
                    "type": "string",
                    "description": "The name of the base image entity",
                    "minLength": 1
                  },
                  "type": {
                    "type": "string",
                    "enum": ["base-image"],
                    "description": "The type of the dependency"
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}
