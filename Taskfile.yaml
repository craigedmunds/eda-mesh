version: '3'

includes:
  # argocd:
  #   taskfile: platform/kustomize/seed/argocd/Taskfile.yaml
  seed:
    taskfile: platform/kustomize/seed/Taskfile.yaml
    dir: platform/kustomize/seed
  platform:
    taskfile: platform/Taskfile.yaml
    dir: platform
  backstage:
    taskfile: backstage/Taskfile.yaml
    dir: backstage
  eda:
    taskfile: eda/Taskfile.yaml
    dir: eda
  images:
    taskfile: image-factory/Taskfile.yaml
    dir: image-factory
  uv:
    taskfile: apps/uv/Taskfile.yaml
    dir: apps/uv

  workspace-shared:
    taskfile: libs/workspace-shared/Taskfile.yaml
    # dir: ../dev-common

tasks:
  status:
    desc: Run all the status' methods
    cmds:
      - task: seed:status
      - task: platform:status
      - task: argocd:status
      - cmd: echo "Done"
        # silent: true

  # Change detection testing tasks
  test:changed:
    desc: "Run tests for components that have changed compared to main"
    cmds:
      - ./scripts/run-changed-tests.sh all

  test:changed:unit:
    desc: "Run unit tests for components that have changed"
    cmds:
      - ./scripts/run-changed-tests.sh unit

  test:changed:integration:
    desc: "Run integration tests for components that have changed"
    cmds:
      - ./scripts/run-changed-tests.sh integration

  test:changed:acceptance:
    desc: "Run acceptance tests for components that have changed"
    cmds:
      - ./scripts/run-changed-tests.sh acceptance

  # CI/CD synchronization validation
  validate:ci-sync:
    desc: "Validate that all GitHub Actions use task commands exclusively"
    cmds:
      - cmd: |
          echo "ðŸ” Validating CI/CD synchronization..."
          
          # Check that no workflow files contain inline test execution commands
          echo "Checking for inline test execution commands in workflows..."
          INLINE_COMMANDS=$(grep -r "run:.*pytest\|run:.*npm test\|run:.*go test" .github/workflows/ --exclude="*.md" || true)
          if [ -n "$INLINE_COMMANDS" ]; then
            echo "âŒ ERROR: Found inline test execution commands in workflows:"
            echo "$INLINE_COMMANDS"
            echo ""
            echo "All test execution should use 'task test:*' pattern instead"
            exit 1
          fi
          
          # Check that all test workflows use task commands
          echo "Checking that workflows use task commands..."
          WORKFLOW_FILES=$(find .github/workflows/ -name "*.yml" -o -name "*.yaml" | grep -v "_component-test.yml")
          MISSING_TASK_COMMANDS=""
          
          for workflow in $WORKFLOW_FILES; do
            if grep -q "test" "$workflow" && ! grep -q "task test:" "$workflow" && ! grep -q "uses: ./.github/workflows/_component-test.yml" "$workflow"; then
              MISSING_TASK_COMMANDS="$MISSING_TASK_COMMANDS\n$workflow"
            fi
          done
          
          if [ -n "$MISSING_TASK_COMMANDS" ]; then
            echo "âš ï¸  WARNING: Some workflows may not use task commands:"
            echo -e "$MISSING_TASK_COMMANDS"
            echo ""
            echo "Consider updating these workflows to use 'task test:*' commands"
          fi
          
          # Check that reusable workflow uses only task commands for execution
          echo "Checking reusable workflow..."
          if [ -f ".github/workflows/_component-test.yml" ]; then
            if grep -q "run:.*pytest\|run:.*npm test\|run:.*go test" ".github/workflows/_component-test.yml"; then
              echo "âŒ ERROR: Reusable workflow contains inline test execution commands"
              echo "The reusable workflow should only use 'task test:*' commands for execution"
              exit 1
            fi
          fi
          
          echo "âœ… CI/CD synchronization validation passed"

  # Documentation generation tasks
  docs:update:
    desc: "Update all auto-generated documentation"
    deps: [docs:taskfile]
    cmds:
      - cmd: echo "âœ… All documentation updated"
        silent: true

  # Development workflow - most commonly used
  dev:apply:
    desc: Apply kustomize directly (bypassing ArgoCD) for development
    vars:
      PATH: '{{.PATH | default "platform/kustomize/seed/overlays/local/lab"}}'
    cmds:
      - kustomize build {{.PATH}} --enable-helm | kubectl apply --server-side=true -f -
      - cmd: echo "Applied {{.PATH}} directly to cluster"
        silent: true

  dev:diff:
    desc: Show diff between local changes and cluster state
    vars:
      PATH: '{{.PATH | default "platform/kustomize/seed/overlays/local/lab"}}'
    cmds:
      - kustomize build {{.PATH}} --enable-helm | kubectl diff -f -

  # Essential cluster information
  cluster:info:
    desc: Show cluster and context information
    cmds:
      - cmd: echo "=== Current Context ==="
        silent: true
      - kubectl config current-context
      - cmd: echo -e "\n=== Cluster Info ==="
        silent: true
      - kubectl cluster-info
      - cmd: echo -e "\n=== Node Status ==="
        silent: true
      - kubectl get nodes -o wide

  # Quick troubleshooting
  pods:
    desc: Show pods that are not running
    cmds:
      - kubectl get pods -A --field-selector=status.phase!=Running,status.phase!=Succeeded

  # Kafka tasks
  kafka:producer:
    desc: Run Kafka console producer (interactive)
    vars:
      TOPIC: '{{.TOPIC | default "my-topic"}}'
    cmds:
      - kubectl run kafka-producer -n kafka --image=quay.io/strimzi/kafka:0.49.1-kafka-4.1.1 --rm=true --restart=Never -ti --overrides='{"spec":{"tolerations":[{"key":"node-role.kubernetes.io/control-plane","operator":"Exists","effect":"NoSchedule"}]}}' -- bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9092 --topic {{.TOPIC}}

  kafka:consumer:
    desc: Run Kafka console consumer
    vars:
      TOPIC: '{{.TOPIC | default "my-topic"}}'
    cmds:
      - kubectl run kafka-consumer -n kafka --image=quay.io/strimzi/kafka:0.49.1-kafka-4.1.1 --rm=true --restart=Never -ti --overrides='{"spec":{"tolerations":[{"key":"node-role.kubernetes.io/control-plane","operator":"Exists","effect":"NoSchedule"}]}}' -- bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9092 --topic {{.TOPIC}} --from-beginning

  kafka:topics:
    desc: List Kafka topics
    cmds:
      - kubectl run kafka-topics -n kafka --image=quay.io/strimzi/kafka:0.49.1-kafka-4.1.1 --rm=true --restart=Never --overrides='{"spec":{"tolerations":[{"key":"node-role.kubernetes.io/control-plane","operator":"Exists","effect":"NoSchedule"}]}}' -- bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9092 --list

  # Documentation tasks

  # IMPORTANT: This only works because we import
  # dev-common/Taskfile.yaml without setting dir
  # If we find we need to set dir, we'll need to reconsider this 
  docs:taskfile:
    desc: Generate/update the taskfile steering documentation
    cmds:
      - task: workspace-shared:docs:taskfile
      - |
        cat >> .kiro/steering/taskfile.md << 'EOF'
       
        ## Essential Daily Tasks

        ### Development Workflow
        - `task dev:apply` - Apply kustomize directly (bypassing ArgoCD) for development
        - `task dev:diff` - Show diff between local changes and cluster state
        - `task cluster:info` - Show cluster and context information
        - `task pods` - Show pods that are not running (quick troubleshooting)

        ### Status and Monitoring
        - `task status` - Run all status methods across components
        - `task argocd:status` - Print status for ArgoCD
        - `task backstage:status` - Show Backstage application and pod status
        - `task images:status` - Show comprehensive status of Image Factory components

        ### Testing
        - Use component-specific test tasks (e.g., \`task backstage:test:all\`, \`task images:test:all\`)
        - \`task test:changed\` - Run tests for components that have changed
        - \`task test:changed:unit\` - Run unit tests for changed components
        - \`task test:changed:integration\` - Run integration tests for changed components
        - \`task test:changed:acceptance\` - Run acceptance tests for changed components

        ## Task Categories

        ### ArgoCD Management
        - Pause/resume sync for development workflow
        - Check application status and troubleshoot issues
        - Access UI and get credentials

        ### Development and Testing
        - Apply configurations directly for rapid iteration
        - Run comprehensive test suites
        - Debug and troubleshoot components

        ### Monitoring and Status
        - Check overall system health
        - Monitor specific component status
        - View logs and artifacts

        ### Infrastructure Components
        - Backstage: Developer portal and catalog
        - Image Factory: Container image building and promotion
        - EDA: Event-driven architecture mesh
        - Ingress: Traffic routing and SSL management
        - Secrets: Central secret management

        ## Best Practices

        1. **Always check status first** - Use `task status` or component-specific status tasks
        2. **Use the development workflow** - Pause ArgoCD, apply directly, test, then resume
        3. **Run tests before committing** - Use appropriate test tasks for your changes
        4. **Leverage existing tasks** - Don't reinvent commands that already exist
        5. **Update tasks when needed** - If you find yourself running the same commands repeatedly, add them to a Taskfile

        EOF
      - cmd: echo "Updated .kiro/steering/taskfile.md with current task list"
        silent: true
