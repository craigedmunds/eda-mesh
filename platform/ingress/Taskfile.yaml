version: '3'

tasks:
  status:
    desc: Check ingress status and troubleshoot connectivity issues
    vars:
      HOST: '{{.HOST | default "argocd.lab.local.ctoaas.co"}}'
    cmds:
      - cmd: echo "###############################################"
        silent: true
      - cmd: echo "Ingress Status Check for {{.HOST}}"
        silent: true
      - cmd: echo "###############################################"
        silent: true
      - cmd: echo "0. All Ingress Resources:"
        silent: true
      - kubectl get ingress -A
      - cmd: echo "1. Ingress Resources For Hostname {{.HOST}}:"
        silent: true
      - kubectl get ingress -A | grep -E "(NAMESPACE|{{.HOST}})" || echo "No ingress found for {{.HOST}}"
      - cmd: echo ""
        silent: true
      - cmd: echo "2. Ingress Details for {{.HOST}}:"
        silent: true
      - |
        INGRESS_INFO=$(kubectl get ingress -A -o json | jq -r '.items[] | select(.spec.rules[]?.host == "{{.HOST}}") | "\(.metadata.namespace)/\(.metadata.name)"' | head -1)
        if [ -n "$INGRESS_INFO" ]; then
          NAMESPACE=$(echo $INGRESS_INFO | cut -d'/' -f1)
          NAME=$(echo $INGRESS_INFO | cut -d'/' -f2)
          echo "Found ingress: $NAME in namespace: $NAMESPACE"
          kubectl describe ingress $NAME -n $NAMESPACE
        else
          echo "No ingress found for {{.HOST}}"
        fi
      - cmd: echo ""
        silent: true
      - cmd: echo "3. Backend Services for {{.HOST}}:"
        silent: true
      - |
        kubectl get ingress -A -o json | jq -r '.items[] | select(.spec.rules[]?.host == "{{.HOST}}") | .spec.rules[].http.paths[] | "\(.backend.service.namespace // "same-ns")/\(.backend.service.name):\(.backend.service.port.number // .backend.service.port.name)"' | while read svc_info; do
          if [ -n "$svc_info" ]; then
            echo "Backend service: $svc_info"
            SVC_NS=$(echo $svc_info | cut -d'/' -f1)
            SVC_NAME=$(echo $svc_info | cut -d'/' -f2 | cut -d':' -f1)
            if [ "$SVC_NS" = "same-ns" ]; then
              SVC_NS=$(kubectl get ingress -A -o json | jq -r '.items[] | select(.spec.rules[]?.host == "{{.HOST}}") | .metadata.namespace' | head -1)
            fi
            kubectl get svc $SVC_NAME -n $SVC_NS 2>/dev/null || echo "Service $SVC_NAME not found in $SVC_NS"
          fi
        done
      - cmd: echo ""
        silent: true
      - cmd: echo "4. Traefik Ingress Controller Status:"
        silent: true
      - kubectl get pods -n traefik-system -l app.kubernetes.io/name=traefik || kubectl get pods -A -l app.kubernetes.io/name=traefik
      - cmd: echo ""
        silent: true
      - cmd: echo "5. Traefik Services:"
        silent: true
      - kubectl get svc -n traefik-system -l app.kubernetes.io/name=traefik || kubectl get svc -A -l app.kubernetes.io/name=traefik
      - cmd: echo ""
        silent: true
      - cmd: echo "6. HTTP Test:"
        silent: true
      - |
        echo "Testing HTTP connection to {{.HOST}}..."
        curl -I -k https://{{.HOST}} 2>&1 | head -10 || echo "Connection failed"

  ssl:check:
    desc: Check SSL certificate status for a given host
    vars:
      HOST: '{{.HOST | default "argocd.lab.local.ctoaas.co"}}'
    cmds:
      - cmd: echo "###############################################"
        silent: true
      - cmd: echo "SSL Certificate Check for {{.HOST}}"
        silent: true
      - cmd: echo "###############################################"
        silent: true
      - cmd: echo "1. Certificate Resources:"
        silent: true
      - kubectl get certificate -A | grep -E "(NAMESPACE|{{.HOST}})" || echo "No certificates found for {{.HOST}}"
      - cmd: echo ""
        silent: true
      - cmd: echo "2. Certificate Details:"
        silent: true
      - |
        CERT_NAME=$(kubectl get certificate -A -o json | jq -r '.items[] | select(.spec.dnsNames[]? | contains("{{.HOST}}")) | "\(.metadata.namespace)/\(.metadata.name)"' | head -1)
        if [ -n "$CERT_NAME" ]; then
          NAMESPACE=$(echo $CERT_NAME | cut -d'/' -f1)
          NAME=$(echo $CERT_NAME | cut -d'/' -f2)
          echo "Found certificate: $NAME in namespace: $NAMESPACE"
          kubectl describe certificate $NAME -n $NAMESPACE
        else
          echo "No certificate found for {{.HOST}}"
        fi
      - cmd: echo ""
        silent: true
      - cmd: echo "3. ACME Challenge Status:"
        silent: true
      - |
        kubectl get challenge -A -o json | jq -r '.items[] | select(.spec.dnsName == "{{.HOST}}") | "\(.metadata.namespace)/\(.metadata.name)"' | while read challenge; do
          if [ -n "$challenge" ]; then
            NAMESPACE=$(echo $challenge | cut -d'/' -f1)
            NAME=$(echo $challenge | cut -d'/' -f2)
            echo "Challenge: $NAME in namespace: $NAMESPACE"
            kubectl describe challenge $NAME -n $NAMESPACE
          fi
        done || echo "No challenges found for {{.HOST}}"
      - cmd: echo ""
        silent: true
      - cmd: echo "4. ClusterIssuer Status:"
        silent: true
      - kubectl get clusterissuer -o wide
      - cmd: echo ""
        silent: true
      - cmd: echo "5. External Secrets Status:"
        silent: true
      - kubectl get externalsecret -A | grep cloudflare || echo "No cloudflare external secrets found"
      - cmd: echo ""
        silent: true
      - cmd: echo "6. Cloudflare API Token Secret:"
        silent: true
      - |
        for ns in $(kubectl get ns -o jsonpath='{.items[*].metadata.name}'); do
          if kubectl get secret cloudflare-api-token -n $ns >/dev/null 2>&1; then
            echo "‚úì Secret exists in $ns namespace"
          fi
        done
      - cmd: echo ""
        silent: true
      - cmd: echo "7. SSL Test (curl):"
        silent: true
      - |
        echo "Testing HTTPS connection to {{.HOST}}..."
        curl -I https://{{.HOST}} 2>&1 | head -5 || echo "Connection failed"

  cert:debug:
    desc: Debug certificate issues for a specific certificate
    vars:
      NAMESPACE: '{{.NAMESPACE | default "argocd"}}'
      CERT_NAME: '{{.CERT_NAME | default "argocd-ctoaas-tls"}}'
    cmds:
      - cmd: echo "###############################################"
        silent: true
      - cmd: 'echo "Certificate Debug: {{.CERT_NAME}} in {{.NAMESPACE}}"'
        silent: true
      - cmd: echo "###############################################"
        silent: true
      - 'kubectl describe certificate {{.CERT_NAME}} -n {{.NAMESPACE}}'
      - cmd: echo ""
        silent: true
      - cmd: echo "Certificate Request:"
        silent: true
      - |
        CR_NAME=$(kubectl get certificaterequest -n {{.NAMESPACE}} -o json | jq -r '.items[] | select(.metadata.ownerReferences[]?.name == "{{.CERT_NAME}}") | .metadata.name' | head -1)
        if [ -n "$CR_NAME" ]; then
          kubectl describe certificaterequest $CR_NAME -n {{.NAMESPACE}}
        else
          echo "No certificate request found"
        fi
      - cmd: echo ""
        silent: true
      - cmd: echo "ACME Order:"
        silent: true
      - |
        ORDER_NAME=$(kubectl get order -n {{.NAMESPACE}} -o json | jq -r '.items[] | select(.metadata.annotations["cert-manager.io/certificate-name"] == "{{.CERT_NAME}}") | .metadata.name' | head -1)
        if [ -n "$ORDER_NAME" ]; then
          kubectl describe order $ORDER_NAME -n {{.NAMESPACE}}
        else
          echo "No ACME order found"
        fi

  # Kustomize ingress testing
  test:
    desc: Run all kustomize ingress build tests
    dir: tests/kustomize
    cmds:
      - cmd: echo "üß™ Running kustomize ingress build tests..."
        silent: true
      - cmd: |
          if [ -n "$CI" ]; then
            python -m pytest -v --tb=short
          else
            .venv/bin/python -m pytest -v --tb=short
          fi
      - cmd: echo "‚úÖ All kustomize ingress tests passed"
        silent: true

  test:sample:build:
    desc: Run sample generation
    dir: ../kustomize/_common/tests/ingress
    cmds:
      - cmd: echo "üß™ Running component tests..."
        silent: true
      - silent: true
        cmd: |
          echo "Building kustomize configuration..."
          kustomize build .

  test:sample:
    desc: Run sample ReplacementTransformer component tests with IngressRoute generation
    dir: ../kustomize/_common/tests/ingress
    cmds:
      - cmd: echo "üß™ Running ReplacementTransformer component tests..."
        silent: true
      - silent: true
        cmd: |
          echo "Building kustomize configuration..."
          kustomize build . > /tmp/ingress-test-output.yaml
          
          echo "‚úÖ Kustomize build successful"
          
          echo "üîç Verifying private IngressRoute transformation..."
          PRIVATE_HOST=$(yq eval 'select(.metadata.name == "sample-ingressroute-private") | .spec.routes[0].match' /tmp/ingress-test-output.yaml)
          echo "Private IngressRoute host match: $PRIVATE_HOST"
          EXPECTED_PRIVATE="Host(\`sample-private.lab.local.ctoaas.co\`)"
          if [[ "$PRIVATE_HOST" == "$EXPECTED_PRIVATE" ]]; then
            echo "‚úÖ Private IngressRoute domain transformation correct"
          else
            echo "‚ùå Private IngressRoute domain transformation failed"
            echo "Expected: $EXPECTED_PRIVATE"
            echo "Got: $PRIVATE_HOST"
            exit 1
          fi
          
          echo "üîç Verifying private IngressRoute TLS configuration..."
          PRIVATE_TLS=$(yq eval 'select(.metadata.name == "sample-ingressroute-private") | .spec.tls.certResolver' /tmp/ingress-test-output.yaml)
          echo "Private TLS cert resolver: $PRIVATE_TLS"
          if [[ "$PRIVATE_TLS" == "letsencrypt-prod" ]]; then
            echo "‚úÖ Private IngressRoute TLS configuration correct"
          else
            echo "‚ùå Private IngressRoute TLS configuration failed"
            exit 1
          fi
          
          echo "üîç Verifying public IngressRoute transformation..."
          PUBLIC_HOST=$(yq eval 'select(.metadata.name == "sample-ingressroute-public") | .spec.routes[0].match' /tmp/ingress-test-output.yaml)
          echo "Public IngressRoute host match: $PUBLIC_HOST"
          EXPECTED_PUBLIC="Host(\`sample-public.lab.local.ctoaas.co\`) || Host(\`sample-public.lab.ctoaas.co\`)"
          if [[ "$PUBLIC_HOST" == "$EXPECTED_PUBLIC" ]]; then
            echo "‚úÖ Public IngressRoute dual domain transformation correct"
          else
            echo "‚ùå Public IngressRoute dual domain transformation failed"
            echo "Expected: $EXPECTED_PUBLIC"
            echo "Got: $PUBLIC_HOST"
            exit 1
          fi
          
          echo "üîç Verifying public IngressRoute TLS configuration..."
          PUBLIC_TLS=$(yq eval 'select(.metadata.name == "sample-ingressroute-public") | .spec.tls.certResolver' /tmp/ingress-test-output.yaml)
          echo "Public TLS cert resolver: $PUBLIC_TLS"
          if [[ "$PUBLIC_TLS" == "letsencrypt-prod" ]]; then
            echo "‚úÖ Public IngressRoute TLS configuration correct"
          else
            echo "‚ùå Public IngressRoute TLS configuration failed"
            exit 1
          fi
          
          echo "‚úÖ All ReplacementTransformer component tests passed successfully"
          
          # Clean up
          # rm -f /tmp/ingress-test-output.yaml

  test:argocd:
    desc: Run ArgoCD ingress build tests
    dir: tests/kustomize
    cmds:
      - cmd: echo "üß™ Running ArgoCD ingress tests..."
        silent: true
      - cmd: |
          if [ -n "$CI" ]; then
            python -m pytest test_argocd_ingress.py -v --tb=short -m argocd
          else
            .venv/bin/python -m pytest test_argocd_ingress.py -v --tb=short -m argocd
          fi
      - cmd: echo "‚úÖ ArgoCD ingress tests passed"
        silent: true

  test:backstage:
    desc: Run Backstage ingress build tests
    dir: tests/kustomize
    cmds:
      - cmd: echo "üß™ Running Backstage ingress tests..."
        silent: true
      - cmd: |
          if [ -n "$CI" ]; then
            python -m pytest test_backstage_ingress.py -v --tb=short -m backstage
          else
            .venv/bin/python -m pytest test_backstage_ingress.py -v --tb=short -m backstage
          fi
      - cmd: echo "‚úÖ Backstage ingress tests passed"
        silent: true

  test:kargo:
    desc: Run Kargo ingress build tests
    dir: tests/kustomize
    cmds:
      - cmd: echo "üß™ Running Kargo ingress tests..."
        silent: true
      - cmd: |
          if [ -n "$CI" ]; then
            python -m pytest test_kargo_ingress.py -v --tb=short -m kargo
          else
            .venv/bin/python -m pytest test_kargo_ingress.py -v --tb=short -m kargo
          fi
      - cmd: echo "‚úÖ Kargo ingress tests passed"
        silent: true

  test:install:
    desc: Install dependencies for kustomize ingress tests
    dir: tests/kustomize
    cmds:
      - cmd: echo "üì¶ Installing kustomize test dependencies..."
        silent: true
      - cmd: |
          if [ -n "$CI" ]; then
            # In CI, install directly
            pip install -r requirements.txt
          else
            # Locally, use venv
            python3 -m venv .venv
            .venv/bin/pip install -r requirements.txt
          fi
      - cmd: echo "‚úÖ Dependencies installed"
        silent: true