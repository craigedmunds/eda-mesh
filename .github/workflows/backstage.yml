name: Build and Push Backstage

on:
  push:
    branches:
      - main
      - feature/backstage-events
    paths:
      - 'apps/backstage/**'
      - '.github/workflows/backstage.yml'
      - '.github/workflows/reusable-docker-build.yml'
  
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  build-and-push:
    uses: ./.github/workflows/reusable-docker-build.yml
    with:
      app_name: 'Backstage'
      image_name: 'craigedmunds/backstage'
      dockerfile: 'apps/backstage/packages/backend/Dockerfile'
      context: 'apps/backstage'
      version_file: 'apps/backstage/package.json'
      version_type: 'package-json'
      pre_build_script: |
        cd apps/backstage
        cp .yarnrc.ci.yml .yarnrc.yml
      # Pass through version_bump input if present
      version_bump: ${{ inputs.version_bump || 'patch' }}
    secrets: inherit