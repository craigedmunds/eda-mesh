postgresql:
  enabled: true

ingress:
  enabled: false

# https://artifacthub.io/packages/helm/backstage/backstage
serviceAccount:
  create: true
  name: backstage

backstage:
  image:
    # registry: ghcr.io
    repository: craigedmunds/backstage
    tag: '0.0.1'
    pullSecrets:
      - gh-docker-registry-creds
  extraEnvVars:
    - name: NODE_ENV
      value: "development"
    - name: BACKSTAGE_AUTH_LEGACY_GUEST
      value: "true"
    - name: AUTH_GUEST_PROVIDER_ENABLED
      value: "true"
    - name: BACKEND_SECRET
      value: dev-backstage-key
    - name: IMAGE_FACTORY_GIT_REPO
      value: "https://github.com/craigedmunds/argocd-eda.git"
    - name: IMAGE_FACTORY_GIT_BRANCH
      value: "feature/backstage-events"
    - name: IMAGE_FACTORY_IMAGES_YAML_PATH
      value: "image-factory/images.yaml"
  extraEnvVarsSecrets:
    - gh-oauth
  extraVolumes:
    - name: backstage-root-location
      configMap:
        name: backstage-root-location
    - name: backstage-catalog
      configMap:
        name: backstage-catalog
    
  extraVolumeMounts:
    - name: backstage-root-location
      mountPath: /etc/backstage/catalog
      readOnly: true
    - name: backstage-catalog
      mountPath: /etc/backstage/catalog/catalog-items
      readOnly: true
    
  appConfig:
    app:
      title: Backstage
      baseUrl: https://backstage.lab.local.ctoaas.co
    backend:
      baseUrl: https://backstage.lab.local.ctoaas.co
      cors:
        origin: https://backstage.lab.local.ctoaas.co
        credentials: true
        methods: [GET, POST, PUT, DELETE, PATCH]
        allowedHeaders: [Authorization, Content-Type, Cookie]
      auth:
        keys:
          - secret: ${BACKEND_SECRET}
      reading:
        allow:
          # Could use "*.svc.cluster.local" if we end up with more
          - host: backstage-catalog-api-uv.backstage-catalog-api.svc.cluster.local
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}
    proxy:
      endpoints:
        '/github-api':
          target: 'https://api.github.com'
          changeOrigin: true
          allowedHeaders: ['Authorization', 'Accept']
          headers:
            Authorization: 'token ${GITHUB_TOKEN}'
            Accept: 'application/vnd.github.v3+json'
          credentials: 'dangerously-allow-unauthenticated'
        '/dockerhub-api':
          target: 'https://hub.docker.com'
          changeOrigin: true
          allowedHeaders: ['Accept']
          headers:
            Accept: 'application/json'
          credentials: 'dangerously-allow-unauthenticated'
    auth:
      environment: development
      providers:
        guest: {}
        github:
          production:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
            callbackUrl: https://backstage.lab.local.ctoaas.co/api/auth/github/handler/frame
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
          development:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
            callbackUrl: https://backstage.lab.local.ctoaas.co/api/auth/github/handler/frame
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
    catalog:
      rules:
        - allow: [Domain, Component, System, API, Resource, Location, Event, ManagedImage, BaseImage]
      locations:
        - type: file
          target: /etc/backstage/catalog/rootlocation.yaml
          # rules:
          #   - allow: [Location, User, Group, Domain, Component, System, Resource, API, Event, ManagedImage, BaseImage]
          presence: required

        # Local example data, file locations are relative to the backend process, typically `packages/backend`
        - type: file
          target: ./examples/entities.yaml

        # Local example template
        - type: file
          target: ./examples/template/template.yaml
          rules:
            - allow: [Template]

        # Image Factory enrollment template
        - type: file
          target: ./examples/template/enroll-image-template.yaml
          rules:
            - allow: [Template]

        # Local example organizational data
        # - type: file
        #   target: ./examples/org.yaml
        #   rules:
        #     - allow: [User, Group]

        - type: file
          target: ./examples/images.yaml
          rules:
            - allow: [ManagedImage, BaseImage]
        
        - type: url
          metadata:
            name: mesh-backstage-catalog-api
          target: http://backstage-catalog-api-uv.backstage-catalog-api.svc.cluster.local/
          # rules:
          #   - allow: [Domain, Component, System, Resource, API, Location, User, Group, Event]
          presence: required
      providers:
        github:
          # Organization-wide repository discovery
          # Note: Update 'organization' to match your GitHub organization
          ctoaas:
            organization: 'ctoaas'
            catalogPath: '/catalog-info.yaml'  # Optional: look for catalog files in repositories
            filters:
              branch: 'main'
              repository: '.*'  # Discover all repositories
            schedule:
              frequency: { minutes: 30 }
              timeout: { minutes: 3 }
        githubOrg:
          # Organization structure discovery (teams, users)
          default:
            id: production
            orgUrl: 'https://github.com/ctoaas'
            schedule:
              frequency: { hours: 1 }
              timeout: { minutes: 15 }
        kubernetes:
          local-cluster:
            cluster: in-cluster
            processor:
              namespaceOverride: default
              defaultOwner: apim
            schedule:
              frequency:
                seconds: 30
              timeout:
                seconds: 5
    signIn:
      resolvers:
        - resolver: guest
    techdocs:
      builder: local
      generator:
        runIn: docker
      publisher:
        type: local
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: config
          clusters:
            - name: in-cluster
              url: https://kubernetes.default.svc
              authProvider: serviceAccount
              skipTLSVerify: true
    imageFactory:
      gitRepo: ${IMAGE_FACTORY_GIT_REPO}
      gitBranch: ${IMAGE_FACTORY_GIT_BRANCH}
      imagesYamlPath: ${IMAGE_FACTORY_IMAGES_YAML_PATH}
      github:
        token: ${GITHUB_TOKEN}
      
